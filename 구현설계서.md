Based on my analysis of the project, I'll now provide a development design for implementing Exaone integration with minimal changes to the existing codebase.

---

# Exaone 통합 개발 설계서

## 개요

기존 Azure OpenAI 기반 챗봇 시스템에 Exaone 서버리스 엔드포인트를 통합하여, Azure AI Search의 데이터를 활용한 응답 생성 및 스트림 기능을 구현합니다. 기존 구조를 최대한 보존하면서 최소한의 변경으로 목표를 달성합니다.

## 세부 유스케이스

### UC-1: Exaone 응답 생성
1. 사용자 메시지 수신
2. Azure AI Search에서 관련 데이터 검색
3. 검색 결과를 컨텍스트로 포함하여 Exaone API 호출
4. 응답 반환

### UC-2: 스트림 응답 처리
1. SSE(Server-Sent Events) 연결 수립
2. Exaone Stream API 호출
3. 청크 단위 응답 전송
4. 연결 종료

### UC-3: 폴백 처리
1. Exaone API 실패 시 기존 Azure OpenAI로 폴백
2. 에러 로깅 및 모니터링
3. 사용자에게 원활한 서비스 제공

## 주요 모듈 및 역할

### 1. ExaoneConnector 모듈
**위치**: `server/src/connectors/exaone.js`

**역할**:
- Exaone API와의 통신 담당
- OpenAI 호환 클라이언트 설정
- 스트림 및 일반 응답 처리
- 에러 처리 및 재시도 로직

**주요 메서드**:
- `generateResponse()`: 일반 응답 생성
- `generateStreamResponse()`: 스트림 응답 생성
- `formatMessagesWithContext()`: Azure Search 결과를 메시지에 포함

### 2. Enhanced BaseAgent 모듈
**위치**: `server/src/agents/BaseAgent.js` (수정)

**역할**:
- AI 제공자 선택 로직 추가 (Azure OpenAI vs Exaone)
- 환경 변수 기반 자동 선택
- 통합된 인터페이스 제공

**주요 변경사항**:
- `constructor()`: Exaone 커넥터 초기화 추가
- `generateResponse()`: 제공자 선택 로직 추가
- `generateStreamResponse()`: 새로운 스트림 메서드

### 3. Enhanced AgentOrchestrator 모듈
**위치**: `server/src/services/AgentOrchestrator.js` (수정)

**역할**:
- 스트림 응답 처리 개선
- Azure Search 데이터 통합
- 에이전트 간 조율

**주요 변경사항**:
- `processMessageStream()`: Exaone 스트림 지원
- `enrichWithSearchData()`: 검색 데이터 보강 메서드

### 4. Configuration Manager
**위치**: `server/src/config/aiProvider.js`

**역할**:
- AI 제공자 설정 중앙화
- 환경 변수 검증
- 동적 제공자 전환

**주요 기능**:
- 환경 변수 기반 자동 설정
- 폴백 체인 관리
- 연결 상태 모니터링

## 데이터 플로우

```
사용자 요청
    ↓
AgentOrchestrator
    ↓
BaseAgent (PurchaseAgent/SubscriptionAgent)
    ├→ Azure Search (데이터 검색)
    └→ ExaoneConnector (Exaone API 호출)
        ├→ 일반 응답 경로
        └→ 스트림 응답 경로
            ↓
        응답 반환
```

## 환경 변수 설정

**server/.env 파일에 추가할 환경 변수**:

```env
# 기존 환경 변수
AZURE_OPENAI_API_KEY=your_azure_openai_api_key
AZURE_OPENAI_ENDPOINT=https://your-resource.openai.azure.com
AZURE_OPENAI_API_VERSION=2024-02-01
AZURE_OPENAI_DEPLOYMENT=gpt-4-mini
AZURE_SEARCH_API_KEY=your_azure_search_api_key
AZURE_SEARCH_ENDPOINT=https://your-search-service.search.windows.net
AZURE_STORAGE_CONNECTION_STRING=your_storage_connection_string

# Exaone 관련 새로운 환경 변수
FRIENDLI_TOKEN=your_friendli_token_here
EXAONE_MODEL=LGAI-EXAONE/EXAONE-4.0.1-32B
AI_PROVIDER=exaone  # 'azure' 또는 'exaone' (기본값: azure)
ENABLE_STREAMING=true  # 스트림 기능 활성화 여부
EXAONE_MAX_TOKENS=1000  # 최대 토큰 수
EXAONE_TEMPERATURE=0.7  # 생성 온도 설정

# 선택적 환경 변수
EXAONE_TIMEOUT=30000  # API 타임아웃 (밀리초)
ENABLE_FALLBACK=true  # Exaone 실패 시 Azure OpenAI로 폴백
```

## 구현 전략

### 1단계: ExaoneConnector 구현
- OpenAI 클라이언트 라이브러리 활용
- 기존 AzureOpenAIConnector와 동일한 인터페이스 제공

### 2단계: BaseAgent 확장
- 조건부 커넥터 선택 로직 추가
- 기존 메서드 시그니처 유지

### 3단계: 스트림 기능 통합
- 기존 SSE 인프라 활용
- 청크 단위 응답 처리 구현

### 4단계: 검색 데이터 통합
- Azure Search 결과를 프롬프트에 자연스럽게 포함
- 컨텍스트 크기 최적화

## 최소 복잡도 원칙

1. **기존 인터페이스 보존**: 외부 API 변경 없음
2. **조건부 로직 활용**: 환경 변수로 제어
3. **단일 책임 원칙**: 각 모듈은 하나의 역할만 수행
4. **폴백 메커니즘**: 안정성 보장
5. **점진적 마이그레이션**: 단계별 적용 가능

## 테스트 전략

### 단위 테스트
- ExaoneConnector 독립 테스트
- Mock 데이터 활용

### 통합 테스트
- 엔드투엔드 시나리오 테스트
- 폴백 시나리오 검증

### 성능 테스트
- 스트림 응답 지연 시간 측정
- 동시 연결 처리 능력 확인

## 위험 요소 및 완화 방안

### 위험 1: API 호환성
- **완화**: OpenAI 호환 인터페이스 활용

### 위험 2: 네트워크 지연
- **완화**: 타임아웃 설정 및 폴백 메커니즘

### 위험 3: 토큰 제한
- **완화**: 컨텍스트 크기 최적화 및 요약 기능

## 예상 일정

1. **ExaoneConnector 구현**: 2시간
2. **BaseAgent 수정**: 1시간
3. **스트림 기능 통합**: 2시간
4. **테스트 및 디버깅**: 2시간
5. **문서화**: 1시간

**총 예상 시간**: 8시간

## 결론

이 설계는 기존 시스템의 안정성을 유지하면서 Exaone을 점진적으로 통합할 수 있도록 구성되었습니다. 최소한의 코드 변경으로 목표를 달성하며, 필요시 즉시 기존 시스템으로 롤백 가능한 구조입니다.